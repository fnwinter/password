<!DOCTYPE html>
<html>

<head>
  <title>Password Manager</title>
  <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
  <style>
    #loading {
      outline: none;
      border: none;
      background: transparent
    }
  </style>
  <script type="module">
    const loading = document.getElementById('loading');
    addEventListener('py:ready', () => loading.close());
    loading.showModal();
  </script>
</head>

<body>
  <h2>Password Manager</h2>
  <dialog id="loading">
    <h1>Loading...</h1>
  </dialog>
  
  <dialog id="passwordDialog">
    <h3>Enter Master Password</h3>
    <p>This URL contains encrypted data. Please enter the master password to decrypt it.</p>
    <div>
      <label>Master Password: <input type="password" id="dialogMasterPassword" placeholder="Enter master password"></label>
    </div>
    <div>
      <button onclick="decryptUrlData()">Decrypt</button>
      <button onclick="closePasswordDialog()">Cancel</button>
    </div>
  </dialog>
  <hr color="red" size="2px"/>
  <br/>
  <div id="site_info">
  </div>
  <br/>
  <div id="new_site">
    <button onclick="addNewSite()">Add Site</button>
  </div>
  <br/>
  <hr color="red" size="2px"/>
  <br/>
  <div>
    <label>Master Password: <input type="password" id="masterPasswordInput"
        placeholder="Enter master password"></label>
    <label>Confirm Master Password: <input type="password" id="confirmMasterPasswordInput"
        placeholder="Confirm master password"></label>
    <button onclick="toggleMasterPasswords()">Show/Hide</button>
  </div>
  <br/>
  <div>
    <button onclick="generateUrl()">Generate URL</button>
    <div id="call_python"></div>
  </div>
  <br/>
  <hr color="red" size="2px"/>
  <div id="get_url">
    <h3>Get URL
    <button onclick="copyToClipboard()">Copy to Clipboard</button>
    </h3>
    <div>
      <label>
        <textarea id="fullUrlInput" placeholder="Enter full URL" rows="10"
          cols="100"></textarea>
      </label>
    </div>
    <br/>
    <hr color="red" size="2px"/>
    <br/>
  </div>


  <script>
    // Global variables
    let allSites = [];

    function addNewSite() {
      const newSiteDiv = document.getElementById('site_info');
      const siteCount = newSiteDiv.children.length;

      const newDiv = document.createElement('div');
      newDiv.innerHTML = `
                <label>Site: <input type="text" id="siteInput${siteCount}" placeholder="Enter site name or url" size="30"></label>
                <label>Password: <input type="password" id="passwordInput${siteCount}" placeholder="Enter password"></label>
                <button onclick="togglePasswordById('passwordInput${siteCount}')">Show/Hide</button>
                <button onclick="generatePasswordById('passwordInput${siteCount}')">Generate</button>
                <button onclick="copyPasswordToClipboard('passwordInput${siteCount}')">Copy to Clipboard</button>
                <button onclick="deleteSite(${siteCount})">Delete</button>
            `;

      newSiteDiv.appendChild(newDiv);
    }

    function togglePasswordById(inputId) {
      const passwordInput = document.getElementById(inputId);
      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
      } else {
        passwordInput.type = 'password';
      }
    }

    function toggleMasterPasswords() {
      const masterPasswordInput = document.getElementById('masterPasswordInput');
      const confirmMasterPasswordInput = document.getElementById('confirmMasterPasswordInput');
      
      if (masterPasswordInput.type === 'password') {
        masterPasswordInput.type = 'text';
        confirmMasterPasswordInput.type = 'text';
      } else {
        masterPasswordInput.type = 'password';
        confirmMasterPasswordInput.type = 'password';
      }
    }

    function generatePasswordById(inputId) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
      let password = '';
      for (let i = 0; i < 12; i++) {
        password += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById(inputId).value = password;
    }

    function deleteSite(siteIndex) {
      const siteInfo = document.getElementById('site_info');
      const siteDiv = siteInfo.children[siteIndex];
      
      if (siteDiv) {
        siteDiv.remove();
        
        // Update remaining site indices
        for (let i = siteIndex; i < siteInfo.children.length; i++) {
          const remainingDiv = siteInfo.children[i];
          if (remainingDiv) {
            // Update button onclick attributes
            const buttons = remainingDiv.querySelectorAll('button');
            buttons.forEach(button => {
              const onclick = button.getAttribute('onclick');
              if (onclick) {
                if (onclick.includes('copyPasswordToClipboard')) {
                  button.setAttribute('onclick', onclick.replace(/passwordInput\d+/, `passwordInput${i}`));
                } else {
                  button.setAttribute('onclick', onclick.replace(/\d+/g, i));
                }
              }
            });
            
            // Update input IDs
            const inputs = remainingDiv.querySelectorAll('input');
            inputs.forEach(input => {
              const oldId = input.id;
              if (oldId.includes('siteInput') || oldId.includes('passwordInput')) {
                const newId = oldId.replace(/\d+/, i);
                input.id = newId;
              }
            });
          }
        }
      }
    }

    function generateUrl() {
      const fullUrl = document.getElementById('fullUrlInput').value;
      const masterPassword = document.getElementById('masterPasswordInput').value;
      const confirmMasterPassword = document.getElementById('confirmMasterPasswordInput').value;

      if (!masterPassword || !confirmMasterPassword) {
        alert('Please enter both master password fields');
        return;
      }

      if (masterPassword !== confirmMasterPassword) {
        alert('Master passwords do not match');
        return;
      }

      try {
        allSites = [];
        const siteInfo = document.getElementById('site_info');

        for (let i = 0; i < siteInfo.children.length; i++) {
          const siteInput = document.getElementById(`siteInput${i}`);
          const passwordInput = document.getElementById(`passwordInput${i}`);

          if (siteInput && passwordInput && siteInput.value.trim() !== '') {
            allSites.push({
              site: siteInput.value,
              password: passwordInput.value
            });
          }
        }

        callPython(generateUrl.name, JSON.stringify(allSites), masterPassword)

      } catch (error) {
        alert('Invalid URL format' + error);
      }
    }

    function copyToClipboard() {
      const fullUrlInput = document.getElementById('fullUrlInput');
      const textToCopy = fullUrlInput.value;
      
      if (!textToCopy.trim()) {
        alert('No URL to copy.');
        return;
      }
      
      navigator.clipboard.writeText(textToCopy).then(function() {
        alert('URL copied to clipboard!');
      }).catch(function(err) {
        console.error('Clipboard copy failed: ', err);
        alert('Failed to copy to clipboard.');
      });
    }

    function copyPasswordToClipboard(inputId) {
      const passwordInput = document.getElementById(inputId);
      const textToCopy = passwordInput.value;
      
      if (!textToCopy.trim()) {
        alert('No password to copy.');
        return;
      }
      
      navigator.clipboard.writeText(textToCopy).then(function() {
        alert('Password copied to clipboard!');
      }).catch(function(err) {
        console.error('Clipboard copy failed: ', err);
        alert('Failed to copy to clipboard.');
      });
    }

    function callPython(function_name, param1, param2, param3) {
      console.log(function_name, param1, param2, param3);
      const __callPython = document.getElementById('call_python');
      __callPython.setAttribute('data-value',
        JSON.stringify([function_name, param1, param2, param3]));
      __callPython.click();
    }

    function checkUrlForEncryptedData() {
      const urlParams = new URLSearchParams(window.location.search);
      const encryptedData = urlParams.get('d');
      
      if (encryptedData) {
        // Store the encrypted data for later use
        window.encryptedUrlData = encryptedData;
        // Show password dialog
        const passwordDialog = document.getElementById('passwordDialog');
        passwordDialog.showModal();
      }
    }

    function decryptUrlData() {
      const masterPassword = document.getElementById('dialogMasterPassword').value;
      
      if (!masterPassword.trim()) {
        alert('Please enter the master password.');
        return;
      }
      
      if (window.encryptedUrlData) {
        // Call Python function to decrypt the data
        callPython('decryptUrlData', window.encryptedUrlData, masterPassword);
      }
    }

    function closePasswordDialog() {
      const passwordDialog = document.getElementById('passwordDialog');
      passwordDialog.close();
      // Clear the encrypted data
      window.encryptedUrlData = null;
    }

    function handleDecryptedData(decryptedSites) {
      if (decryptedSites && Array.isArray(decryptedSites)) {
        // Clear existing sites
        const siteInfo = document.getElementById('site_info');
        siteInfo.innerHTML = '';
        
        // Add decrypted sites
        decryptedSites.forEach((site, index) => {
          addNewSite();
          const siteInput = document.getElementById(`siteInput${index}`);
          const passwordInput = document.getElementById(`passwordInput${index}`);
          
          if (siteInput && passwordInput) {
            siteInput.value = site.site || '';
            passwordInput.value = site.password || '';
          }
        });
        
        // Close the dialog
        closePasswordDialog();
        alert('Data decrypted and loaded successfully!');
      } else {
        alert('Failed to decrypt data. Please check your master password.');
      }
    }

    window.onload = function () {
      addNewSite();
      checkUrlForEncryptedData();
    }

  </script>

  <script type="py" src="./password.py" config="./password.toml"></script>
</body>

</html>